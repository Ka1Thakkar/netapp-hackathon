# syntax=docker/dockerfile:1.6
#
# Data in Motion – React Web App Dockerfile
#
# Multi-stage build producing a small, static, cache‑friendly image served by Nginx.
# Supports build‑time configuration of backend API base URLs via Vite env variables.
#
# Usage (from repo root):
#   docker build -f deploy/docker/Dockerfile.web \
#     --build-arg VITE_API_PYTHON=/py \
#     --build-arg VITE_API_GO=/go \
#     -t data-motion-web:dev .
#
#   docker run --rm -p 8082:80 data-motion-web:dev
#
# Add to docker-compose.yml (example):
#   web:
#     build:
#       context: ../../
#       dockerfile: deploy/docker/Dockerfile.web
#     ports:
#       - "8082:80"
#     environment:
#       # (Optional) only used if you adopt runtime config injection later
#       API_PY_BASE: /py
#       API_GO_BASE: /go
#     depends_on:
#       - python_api
#       - go_mover
#
# ------------------------------------------------------------------------------
# 1. Build Stage
# ------------------------------------------------------------------------------
FROM node:20-alpine AS build

WORKDIR /app

# Build-time API base overrides (Vite will embed these; defaults align with reverse proxy intentions)
ARG VITE_API_PYTHON=/py
ARG VITE_API_GO=/go

# Export as env (Vite reads process.env + import.meta.env via .env.* mechanism)
# Omit NODE_ENV=production during build so devDependencies (tsc, vite) are installed.
ENV VITE_API_PYTHON=${VITE_API_PYTHON} \
    VITE_API_GO=${VITE_API_GO} \
    CI=true

# Copy project manifest and lockfiles first for better layer caching (lock file optional here)
COPY ui/react/package.json ui/react/package-lock.json* ./
# Provide a deterministic layer if package-lock.json is absent (e.g., not checked in yet)
# If a lockfile exists we'll prefer `npm ci`; otherwise we'll `npm install`.

# Install deps (no lock means npm will resolve latest semver ranges once; ensure reproducibility by adding a lock file)
RUN if [ -s package-lock.json ]; then npm ci --no-audit --no-fund; else npm install --no-audit --no-fund; fi

# Copy source (keep context minimal)
COPY ui/react/ ./

# Build static assets
RUN npm run build

# ------------------------------------------------------------------------------
# 2. Runtime Stage (Nginx)
# ------------------------------------------------------------------------------
FROM nginx:1.27-alpine AS runtime

# Minimal OS hardening
RUN addgroup -g 10001 app && adduser -D -u 10000 -G app app

# Create directory for static assets + a simple health endpoint
WORKDIR /usr/share/nginx/html
RUN mkdir -p /usr/share/nginx/html && \
    printf 'OK\n' > /usr/share/nginx/html/health

# Copy built artifacts
COPY --from=build /app/dist/ /usr/share/nginx/html/

# Custom Nginx config with:
# - SPA fallback (try_files -> index.html)
# - Compression (gzip) for text assets
# - Basic security headers
# - Cache rules: immutable hashed assets vs. index.html
COPY deploy/docker/web-nginx.conf /etc/nginx/conf.d/default.conf

# Fallback if custom config not present (optional inline safeguard):
# (Uncomment below if you do NOT provide web-nginx.conf file)
# RUN if [ ! -f /etc/nginx/conf.d/default.conf ]; then \
#   printf 'server { \
#     listen 80; \
#     server_name _; \
#     root /usr/share/nginx/html; \
#     add_header X-Frame-Options DENY always; \
#     add_header X-Content-Type-Options nosniff always; \
#     add_header Referrer-Policy no-referrer-when-downgrade always; \
#     add_header Content-Security-Policy \"default-src '\''self'\''; style-src '\''self'\'' '\''unsafe-inline'\''; script-src '\''self'\'' '\'unsafe-inline\''\" always; \
#     gzip on; gzip_types text/plain text/css application/javascript application/json image/svg+xml; \
#     location /health { try_files /health =200; } \
#     location / { try_files $uri $uri/ /index.html; } \
#   }' > /etc/nginx/conf.d/default.conf; \
#   fi

EXPOSE 80
ENV NODE_ENV=production

# Healthcheck probes static /health file
HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
  CMD wget -qO- http://127.0.0.1/health || exit 1

USER root

# Nginx is PID 1; no ENTRYPOINT override needed
CMD ["nginx", "-g", "daemon off;"]
